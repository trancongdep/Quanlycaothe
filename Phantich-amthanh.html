<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√¢n t√≠ch √Çm thanh & Nh·∫≠n di·ªán Ngu·ªìn - Web Audio API</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #111; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        h1 { color: #00f2c3; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Container ch√≠nh */
        .analyzer-box { background: #222; padding: 20px; border-radius: 12px; border: 1px solid #444; width: 800px; max-width: 100%; box-shadow: 0 0 20px rgba(0, 242, 195, 0.1); }
        
        /* Canvas v·∫Ω ph·ªï */
        canvas { width: 100%; height: 300px; background: #000; border-radius: 4px; border-bottom: 2px solid #00f2c3; }
        
        /* Khu v·ª±c ƒëi·ªÅu khi·ªÉn */
        .controls { margin-top: 20px; display: flex; gap: 15px; justify-content: center; }
        button { padding: 12px 30px; font-size: 16px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        #btn-start { background: #00f2c3; color: #004d40; }
        #btn-start:hover { background: #00ccb5; transform: scale(1.05); }
        #btn-stop { background: #ff3e3e; color: white; opacity: 0.5; cursor: not-allowed; }
        
        /* Khu v·ª±c k·∫øt qu·∫£ */
        .result-panel { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .info-card { background: #333; padding: 15px; border-radius: 8px; text-align: center; }
        .info-label { color: #aaa; font-size: 0.9rem; margin-bottom: 5px; }
        .info-value { font-size: 1.5rem; font-weight: bold; color: white; }
        
        #source-prediction { color: #e14eca; text-shadow: 0 0 10px rgba(225, 78, 202, 0.5); }
        
        /* Thanh ng∆∞·ª°ng */
        .threshold-bar { width: 100%; height: 4px; background: #444; margin-top: 10px; position: relative; }
        .threshold-indicator { height: 100%; background: #e14eca; width: 0%; transition: width 0.1s; }
    </style>
</head>
<body>

    <h1><i class="fas fa-wave-square"></i> Spectrum Analyzer AI</h1>

    <div class="analyzer-box">
        <canvas id="spectrumCanvas"></canvas>

        <div class="result-panel">
            <div class="info-card">
                <div class="info-label">T·∫ßn s·ªë tr·ªôi (Dominant Freq)</div>
                <div class="info-value"><span id="freq-val">0</span> Hz</div>
            </div>
            <div class="info-card">
                <div class="info-label">K·∫øt lu·∫≠n Ngu·ªìn g√¢y ·ªìn</div>
                <div class="info-value" id="source-prediction">---</div>
            </div>
        </div>

        <div style="margin-top: 15px; text-align: center; font-size: 0.8rem; color: #888;">
            C∆∞·ªùng ƒë·ªô √¢m thanh (dB relative):
            <div class="threshold-bar"><div id="db-bar" class="threshold-indicator"></div></div>
        </div>

        <div class="controls">
            <button id="btn-start" onclick="startListening()">üé§ B·∫ÆT ƒê·∫¶U GHI √ÇM</button>
            <button id="btn-stop" onclick="stopListening()">‚èπÔ∏è D·ª™NG</button>
        </div>
    </div>

<script>
    // --- C·∫§U H√åNH ---
    let audioCtx;
    let analyser;
    let microphone;
    let animationId;
    let isRunning = false;

    // Canvas
    const canvas = document.getElementById('spectrumCanvas');
    const ctx = canvas.getContext('2d');
    
    // Resize canvas resolution
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    // --- 1. KH·ªûI ƒê·ªòNG AUDIO CONTEXT ---
    async function startListening() {
        if (isRunning) return;

        try {
            // Xin quy·ªÅn micro
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // T·∫°o Audio Context
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            
            // C·∫•u h√¨nh FFT (Fast Fourier Transform)
            analyser.fftSize = 2048; // ƒê·ªô ph√¢n gi·∫£i t·∫ßn s·ªë (c√†ng cao c√†ng chi ti·∫øt nh∆∞ng n·∫∑ng)
            const bufferLength = analyser.frequencyBinCount; // = fftSize / 2
            const dataArray = new Uint8Array(bufferLength);

            // K·∫øt n·ªëi: Mic -> Analyser
            microphone = audioCtx.createMediaStreamSource(stream);
            microphone.connect(analyser);

            // UI Updates
            isRunning = true;
            document.getElementById('btn-start').style.opacity = "0.5";
            document.getElementById('btn-stop').style.opacity = "1";
            document.getElementById('btn-stop').style.cursor = "pointer";

            // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p v·∫Ω
            draw(analyser, dataArray, bufferLength);

        } catch (err) {
            alert("L·ªói: Kh√¥ng th·ªÉ truy c·∫≠p Microphone! " + err);
        }
    }

    // --- 2. D·ª™NG GHI √ÇM ---
    function stopListening() {
        if (!isRunning) return;
        
        cancelAnimationFrame(animationId);
        microphone.disconnect();
        audioCtx.close();
        
        isRunning = false;
        document.getElementById('btn-start').style.opacity = "1";
        document.getElementById('btn-stop').style.opacity = "0.5";
        document.getElementById('source-prediction').innerText = "---";
        document.getElementById('freq-val').innerText = "0";
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // --- 3. V√íNG L·∫∂P X·ª¨ L√ù (QUAN TR·ªåNG NH·∫§T) ---
    function draw(analyser, dataArray, bufferLength) {
        // L·∫•y d·ªØ li·ªáu t·∫ßn s·ªë hi·ªán t·∫°i
        analyser.getByteFrequencyData(dataArray);

        // X√≥a m√†n h√¨nh c≈©
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // V·∫Ω ph·ªï t·∫ßn s·ªë (Visualizer)
        const barWidth = (canvas.width / bufferLength) * 2.5;
        let barHeight;
        let x = 0;
        let maxVal = 0;
        let maxIndex = 0;
        let totalEnergy = 0;

        for(let i = 0; i < bufferLength; i++) {
            barHeight = dataArray[i];
            
            // T√¨m ƒë·ªânh t·∫ßn s·ªë (Peak Detection)
            if (barHeight > maxVal) {
                maxVal = barHeight;
                maxIndex = i;
            }
            totalEnergy += barHeight;

            // M√†u s·∫Øc d·ª±a tr√™n chi·ªÅu cao
            ctx.fillStyle = `rgb(${barHeight + 50}, 50, ${255 - barHeight})`;
            ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

            x += barWidth + 1;
        }

        // --- 4. THU·∫¨T TO√ÅN NH·∫¨N D·∫†NG NGU·ªíN (HEURISTIC) ---
        
        // T√≠nh t·∫ßn s·ªë th·ª±c t·∫ø (Hz)
        // C√¥ng th·ª©c: Frequency = Index * SampleRate / FFT_Size
        const nyquist = audioCtx.sampleRate / 2;
        const dominantFreq = (maxIndex * audioCtx.sampleRate) / analyser.fftSize;
        
        // Hi·ªÉn th·ªã Hz
        document.getElementById('freq-val').innerText = dominantFreq.toFixed(0);
        
        // Hi·ªÉn th·ªã thanh nƒÉng l∆∞·ª£ng
        const energyPct = Math.min((maxVal / 255) * 100, 100);
        document.getElementById('db-bar').style.width = energyPct + "%";

        // LOGIC PH√ÇN LO·∫†I (Rule-Based Classification)
        const resultLabel = document.getElementById('source-prediction');
        
        if (maxVal < 50) {
            // Qu√° nh·ªè -> Y√™n tƒ©nh
            resultLabel.innerText = "Y√™n tƒ©nh / Nhi·ªÖu n·ªÅn";
            resultLabel.style.color = "#888";
        } else {
            // C√≥ √¢m thanh r√µ -> Ph√¢n lo·∫°i d·ª±a tr√™n Hz
            if (dominantFreq < 60) {
                // T·∫ßn s·ªë c·ª±c th·∫•p: Rung ƒë·ªông n·ªÅn
                resultLabel.innerText = "Rung ƒë·ªông n·ªÅn / Gi√≥";
                resultLabel.style.color = "#aaa";
            } else if (dominantFreq >= 60 && dominantFreq <= 150) {
                // T·∫ßn s·ªë tr·∫ßm: ƒê·ªông c∆° l·ªõn
                resultLabel.innerText = "üöú ƒê·ªòNG C∆† XE T·∫¢I / M√ÅY N·ªî";
                resultLabel.style.color = "#ff8d00"; // Cam
            } else if (dominantFreq > 150 && dominantFreq <= 400) {
                // T·∫ßn s·ªë trung tr·∫ßm
                resultLabel.innerText = "üöó Xe √¥ t√¥ / Ti·∫øng n√≥i nam";
                resultLabel.style.color = "#00f2c3"; // Xanh
            } else if (dominantFreq > 400 && dominantFreq <= 1000) {
                // T·∫ßn s·ªë trung: Ti·∫øng m√°y c·∫Øt, m√°y khoan (ch·∫ø ƒë·ªô rung)
                resultLabel.innerText = "üî© M√ÅY KHOAN / C·∫ÆT (Rung m·∫°nh)";
                resultLabel.style.color = "#e14eca"; // T√≠m
            } else if (dominantFreq > 1000) {
                // T·∫ßn s·ªë cao: Ti·∫øng r√≠t kim lo·∫°i, c√≤i b√°o ƒë·ªông
                resultLabel.innerText = "‚ö†Ô∏è TI·∫æNG R√çT KIM LO·∫†I / C√íI";
                resultLabel.style.color = "#ff3e3e"; // ƒê·ªè
            }
        }

        animationId = requestAnimationFrame(() => draw(analyser, dataArray, bufferLength));
    }
</script>

</body>
</html>
