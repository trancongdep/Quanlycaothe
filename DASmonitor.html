<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá th·ªëng Gi√°m s√°t C√°p ng·∫ßm DAS - Demo Lu·∫≠n VƒÉn</title>
    <style>
        :root { --bg-color: #1e1e2f; --panel-color: #27293d; --text-color: #e1e1e6; --accent: #e14eca; --danger: #ff3e3e; --safe: #00f2c3; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .sidebar { width: 300px; background: var(--panel-color); padding: 20px; display: flex; flex-direction: column; gap: 15px; box-shadow: 2px 0 10px rgba(0,0,0,0.3); z-index: 10; }
        .main-content { flex: 1; position: relative; display: flex; flex-direction: column; }
        
        /* Map Area */
        #map-container { flex: 2; position: relative; background: #181824; overflow: hidden; cursor: crosshair; }
        canvas#fieldMap { width: 100%; height: 100%; display: block; }
        
        /* Dashboard Area */
        .dashboard { height: 250px; background: var(--panel-color); border-top: 1px solid #333; padding: 15px; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        /* Controls */
        h2 { margin: 0 0 10px 0; color: var(--accent); font-size: 1.2rem; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; color: white; cursor: pointer; transition: 0.2s; font-weight: bold; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-excavator { background: #ff8d00; }
        .btn-drill { background: #ff3e3e; }
        .btn-car { background: #3e82ff; }
        .btn-clear { background: #555; margin-top: 10px; }
        
        .info-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; font-size: 0.9rem; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: var(--safe); margin-right: 5px; }
        .status-danger { background: var(--danger); box-shadow: 0 0 10px var(--danger); animation: pulse 0.5s infinite; }
        
        /* Charts */
        canvas#signalChart { width: 100%; height: 100%; background: #000; border-radius: 4px; border: 1px solid #444; }
        
        /* Overlay Alert */
        #alert-overlay { position: absolute; top: 20px; right: 20px; background: rgba(255, 62, 62, 0.9); padding: 15px 25px; border-radius: 5px; display: none; color: white; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 100; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div>
            <h2>1. Ch·ªçn ph∆∞∆°ng ti·ªán</h2>
            <div class="info-box">Click v√†o n√∫t d∆∞·ªõi ƒë√¢y, sau ƒë√≥ click v√†o b·∫£n ƒë·ªì ƒë·ªÉ th·∫£ ph∆∞∆°ng ti·ªán g√¢y rung ƒë·ªông.</div>
            <div class="btn-group" style="margin-top:10px">
                <button class="btn-excavator" onclick="selectTool('excavator')">üöú Xe Cu·ªëc</button>
                <button class="btn-drill" onclick="selectTool('drill')">üî© M√°y Khoan</button>
                <button class="btn-car" onclick="selectTool('car')">üöó Xe √î t√¥</button>
            </div>
            <button class="btn-clear" onclick="clearVehicles()">üóëÔ∏è X√≥a hi·ªán tr∆∞·ªùng</button>
        </div>

        <div>
            <h2>2. Tr·∫°ng th√°i H·ªá th·ªëng</h2>
            <div class="info-box">
                <div><span id="sys-status" class="status-indicator"></span> <span id="sys-text">B√¨nh th∆∞·ªùng</span></div>
                <div style="margin-top: 10px;">Ng∆∞·ª°ng c·∫£nh b√°o: <b style="color:var(--accent)">0.6</b></div>
                <div>NƒÉng l∆∞·ª£ng thu ƒë∆∞·ª£c: <b id="current-energy">0.0</b></div>
            </div>
        </div>
        
        <div style="margin-top: auto; font-size: 0.8rem; opacity: 0.7;">
            M√¥ ph·ªèng DAS - Lu·∫≠n vƒÉn Th·∫°c sƒ© 2025<br>
            C√¥ng ngh·ªá: C·∫£m bi·∫øn √¢m thanh ph√¢n t√°n
        </div>
    </div>

    <div class="main-content">
        <div id="alert-overlay">‚ö†Ô∏è PH√ÅT HI·ªÜN X√ÇM NH·∫¨P T·∫†I KM 0.45</div>

        <div id="map-container">
            <canvas id="fieldMap"></canvas>
        </div>

        <div class="dashboard">
            <div style="position: relative;">
                <h2 style="position:absolute; top:5px; left:10px; font-size: 0.8rem; opacity: 0.8;">T√çN HI·ªÜU RUNG ƒê·ªòNG TH·ªúI GIAN TH·ª∞C (DAS SIGNAL)</h2>
                <canvas id="signalChart"></canvas>
            </div>
            <div>
                <h2>Ph√¢n t√≠ch v·ªã tr√≠</h2>
                <div class="info-box" id="analysis-log" style="height: 150px; overflow-y: auto; font-family: monospace;">
                    > H·ªá th·ªëng s·∫µn s√†ng...<br>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- C·∫§U H√åNH H·ªÜ TH·ªêNG ---
    const CABLE_Y_POS = 0.5; // V·ªã tr√≠ c√°p (gi·ªØa m√†n h√¨nh theo chi·ªÅu d·ªçc)
    const DETECTION_RADIUS = 150; // B√°n k√≠nh ph√°t hi·ªán (pixel)
    const ALERT_THRESHOLD = 0.6; // Ng∆∞·ª°ng c·∫£nh b√°o
    
    // --- BI·∫æN TO√ÄN C·ª§C ---
    let vehicles = [];
    let selectedType = null;
    let time = 0;
    const mapCanvas = document.getElementById('fieldMap');
    const chartCanvas = document.getElementById('signalChart');
    const ctxMap = mapCanvas.getContext('2d');
    const ctxChart = chartCanvas.getContext('2d');
    
    // D·ªØ li·ªáu bi·ªÉu ƒë·ªì
    let signalData = new Array(200).fill(0);

    // --- KH·ªûI T·∫†O ---
    function resize() {
        mapCanvas.width = mapCanvas.offsetWidth;
        mapCanvas.height = mapCanvas.offsetHeight;
        chartCanvas.width = chartCanvas.offsetWidth;
        chartCanvas.height = chartCanvas.offsetHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- T∆Ø∆†NG T√ÅC NG∆Ø·ªúI D√ôNG ---
    function selectTool(type) {
        selectedType = type;
        document.body.style.cursor = "copy";
    }

    function clearVehicles() {
        vehicles = [];
        log("ƒê√£ x√≥a s·∫°ch hi·ªán tr∆∞·ªùng.");
        document.getElementById('sys-status').className = "status-indicator";
        document.getElementById('sys-text').innerText = "B√¨nh th∆∞·ªùng";
        document.getElementById('alert-overlay').style.display = "none";
    }

    mapCanvas.addEventListener('mousedown', (e) => {
        if (!selectedType) return;
        
        const rect = mapCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // ƒê·∫∑c t√≠nh rung ƒë·ªông c·ªßa t·ª´ng lo·∫°i ph∆∞∆°ng ti·ªán
        let signature = {};
        if (selectedType === 'excavator') {
            signature = { name: "Xe Cu·ªëc", amp: 1.2, freq: 0.2, color: "#ff8d00", icon: "üöú" };
        } else if (selectedType === 'drill') {
            signature = { name: "M√°y Khoan", amp: 1.8, freq: 0.8, color: "#ff3e3e", icon: "üî©" }; // Khoan rung m·∫°nh v√† nhanh
        } else {
            signature = { name: "√î t√¥", amp: 0.5, freq: 0.1, color: "#3e82ff", icon: "üöó" };
        }

        vehicles.push({ x, y, type: selectedType, ...signature });
        log(`ƒê√£ th√™m ${signature.name} t·∫°i v·ªã tr√≠ ${Math.round(x)}px`);
        selectedType = null;
        document.body.style.cursor = "default";
    });

    function log(msg) {
        const div = document.getElementById('analysis-log');
        const timeStr = new Date().toLocaleTimeString();
        div.innerHTML = `> [${timeStr}] ${msg}<br>` + div.innerHTML;
    }

    // --- LOGIC M√î PH·ªéNG DAS (PHYSICS ENGINE) ---
    function calculateSignal() {
        let totalSignal = 0;
        let noise = (Math.random() - 0.5) * 0.2; // Nhi·ªÖu n·ªÅn
        
        // V·ªã tr√≠ c√°p tr√™n b·∫£n ƒë·ªì (ƒê∆∞·ªùng th·∫≥ng ngang)
        const cableY = mapCanvas.height * CABLE_Y_POS;

        let maxThreat = 0;
        let threatLocation = -1;

        vehicles.forEach(v => {
            // 1. T√≠nh kho·∫£ng c√°ch t·ª´ xe ƒë·∫øn c√°p (Euclidean distance)
            // Trong th·ª±c t·∫ø DAS ƒëo kho·∫£ng c√°ch d·ªçc s·ª£i quang, ·ªü ƒë√¢y ta m√¥ ph·ªèng kho·∫£ng c√°ch vu√¥ng g√≥c
            const dist = Math.abs(v.y - cableY); 
            
            // 2. Suy hao t√≠n hi·ªáu theo kho·∫£ng c√°ch (Inverse Square Law gi·∫£ l·∫≠p)
            if (dist < DETECTION_RADIUS) {
                // C√¥ng th·ª©c t·∫°o rung ƒë·ªông gi·∫£ l·∫≠p: 
                // Signal = Amplitude * sin(Frequency * time) * Attenuation
                const attenuation = 1 - (dist / DETECTION_RADIUS); // 1 ·ªü g·∫ßn, 0 ·ªü xa
                
                let vibration = 0;
                if(v.type === 'drill') {
                     // M√°y khoan: T·∫ßn s·ªë cao, ·ªïn ƒë·ªãnh
                     vibration = v.amp * Math.sin(time * 20) * attenuation;
                } else if (v.type === 'excavator') {
                    // Xe cu·ªëc: Rung ƒë·ªông ng·∫Øt qu√£ng, m·∫°nh
                    vibration = v.amp * (Math.sin(time * 5) + Math.random()) * attenuation;
                } else {
                    // Xe √¥ t√¥: √äm h∆°n
                    vibration = v.amp * Math.sin(time * 2) * attenuation;
                }
                
                totalSignal += vibration;

                // X√°c ƒë·ªãnh v·ªã tr√≠ nguy hi·ªÉm nh·∫•t ƒë·ªÉ ƒë·ªãnh v·ªã
                if (attenuation * v.amp > maxThreat) {
                    maxThreat = attenuation * v.amp;
                    threatLocation = v.x;
                }
            }
        });

        return { val: totalSignal + noise, threatLoc: threatLocation, maxEnergy: Math.abs(totalSignal) };
    }

    // --- V√íNG L·∫∂P RENDER (60 FPS) ---
    function animate() {
        time += 0.1;
        ctxMap.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
        ctxChart.clearRect(0, 0, chartCanvas.width, chartCanvas.height);

        // 1. V·∫º B·∫¢N ƒê·ªí (MAP)
        const cableY = mapCanvas.height * CABLE_Y_POS;
        
        // V·∫Ω v√πng h√†nh lang an to√†n
        ctxMap.fillStyle = "rgba(0, 242, 195, 0.05)";
        ctxMap.fillRect(0, cableY - DETECTION_RADIUS, mapCanvas.width, DETECTION_RADIUS * 2);
        
        // V·∫Ω Tuy·∫øn C√°p (D√¢y d·∫´n)
        ctxMap.beginPath();
        ctxMap.moveTo(0, cableY);
        ctxMap.lineTo(mapCanvas.width, cableY);
        ctxMap.strokeStyle = "#00f2c3";
        ctxMap.lineWidth = 3;
        ctxMap.setLineDash([10, 5]); // N√©t ƒë·ª©t bi·ªÉu th·ªã c√°p ng·∫ßm
        ctxMap.stroke();
        ctxMap.setLineDash([]);
        
        // V·∫Ω text
        ctxMap.fillStyle = "#00f2c3";
        ctxMap.font = "14px Arial";
        ctxMap.fillText("Tuy·∫øn C√°p Ng·∫ßm 220kV (DAS Monitored)", 10, cableY - 10);

        // V·∫Ω c√°c ph∆∞∆°ng ti·ªán
        vehicles.forEach(v => {
            ctxMap.font = "30px Arial";
            ctxMap.fillText(v.icon, v.x - 15, v.y + 10);
            
            // Hi·ªáu ·ª©ng s√≥ng lan truy·ªÅn
            const dist = Math.abs(v.y - cableY);
            if (dist < DETECTION_RADIUS) {
                ctxMap.beginPath();
                ctxMap.arc(v.x, v.y, (Math.sin(time * 2) + 1) * 20, 0, Math.PI * 2);
                ctxMap.strokeStyle = `rgba(255, 62, 62, ${1 - dist/DETECTION_RADIUS})`;
                ctxMap.stroke();
            }
        });

        // 2. X·ª¨ L√ù S·ªê LI·ªÜU DAS
        const data = calculateSignal();
        
        // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì (Rolling buffer)
        signalData.push(data.val);
        signalData.shift();

        // C·∫≠p nh·∫≠t UI nƒÉng l∆∞·ª£ng
        const currentEnergy = Math.abs(data.val).toFixed(2);
        document.getElementById('current-energy').innerText = currentEnergy;

        // 3. LOGIC C·∫¢NH B√ÅO
        const alertBox = document.getElementById('alert-overlay');
        const statusDot = document.getElementById('sys-status');
        const statusText = document.getElementById('sys-text');

        if (data.maxEnergy > ALERT_THRESHOLD) {
            // C√ì X√ÇM NH·∫¨P
            statusDot.className = "status-indicator status-danger";
            statusText.innerText = "C·∫¢NH B√ÅO X√ÇM NH·∫¨P!";
            statusText.style.color = "var(--danger)";
            
            // T√≠nh v·ªã tr√≠ Km gi·∫£ l·∫≠p (Map width = 1km)
            const km = (data.threatLoc / mapCanvas.width).toFixed(3);
            alertBox.style.display = "block";
            alertBox.innerText = `‚ö†Ô∏è C·∫¢NH B√ÅO: X√ÇM NH·∫¨P T·∫†I KM ${km}`;
            
            // V·∫Ω marker ƒë·ªãnh v·ªã tr√™n c√°p
            ctxMap.beginPath();
            ctxMap.arc(data.threatLoc, cableY, 10, 0, Math.PI*2);
            ctxMap.fillStyle = "red";
            ctxMap.fill();
            ctxMap.beginPath();
            ctxMap.moveTo(data.threatLoc, cableY);
            ctxMap.lineTo(data.threatLoc, cableY - 50);
            ctxMap.strokeStyle = "red";
            ctxMap.stroke();
            ctxMap.fillStyle = "white";
            ctxMap.fillText(`Target: Km ${km}`, data.threatLoc + 10, cableY - 50);

        } else {
            // B√åNH TH∆Ø·ªúNG
            statusDot.className = "status-indicator";
            statusText.innerText = "H·ªá th·ªëng B√¨nh th∆∞·ªùng";
            statusText.style.color = "var(--text-color)";
            alertBox.style.display = "none";
        }

        // 4. V·∫º BI·ªÇU ƒê·ªí T√çN HI·ªÜU
        ctxChart.beginPath();
        ctxChart.strokeStyle = "#e14eca";
        ctxChart.lineWidth = 2;
        const sliceWidth = chartCanvas.width / signalData.length;
        let x = 0;
        
        // V·∫Ω tr·ª•c gi·ªØa
        ctxChart.strokeStyle = "#333";
        ctxChart.moveTo(0, chartCanvas.height/2);
        ctxChart.lineTo(chartCanvas.width, chartCanvas.height/2);
        ctxChart.stroke();

        ctxChart.beginPath();
        ctxChart.strokeStyle = "#e14eca";
        for(let i = 0; i < signalData.length; i++) {
            // Scale gi√° tr·ªã v√†o gi·ªØa bi·ªÉu ƒë·ªì
            const y = (chartCanvas.height / 2) - (signalData[i] * 30); 
            if(i === 0) ctxChart.moveTo(x, y);
            else ctxChart.lineTo(x, y);
            x += sliceWidth;
        }
        ctxChart.stroke();
        
        // V·∫Ω ng∆∞·ª°ng c·∫£nh b√°o tr√™n bi·ªÉu ƒë·ªì
        const thresholdY = (chartCanvas.height / 2) - (ALERT_THRESHOLD * 30);
        ctxChart.beginPath();
        ctxChart.strokeStyle = "red";
        ctxChart.setLineDash([5, 5]);
        ctxChart.moveTo(0, thresholdY);
        ctxChart.lineTo(chartCanvas.width, thresholdY);
        ctxChart.stroke();
        ctxChart.setLineDash([]);

        requestAnimationFrame(animate);
    }

    animate();
</script>
</body>
</html>
