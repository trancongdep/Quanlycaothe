<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TRUNG TÂM ĐIỀU ĐỘ DAS (MONITOR)</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --bg-color: #1e1e2f; --panel-color: #27293d; --text-color: #e1e1e6; --accent: #e14eca; --danger: #ff3e3e; --safe: #00f2c3; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 250px; background: var(--panel-color); padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.3); z-index: 10; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        #map-container { flex: 2; position: relative; background: #181824; }
        canvas#fieldMap { width: 100%; height: 100%; display: block; }
        .dashboard { height: 250px; background: var(--panel-color); border-top: 1px solid #333; padding: 15px; display: flex; gap: 20px; }
        canvas#signalChart { flex: 2; background: #000; border: 1px solid #444; }
        
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: var(--safe); margin-right: 8px; }
        .status-danger { background: var(--danger); box-shadow: 0 0 15px var(--danger); animation: pulse 0.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #alert-overlay { position: absolute; top: 20px; right: 20px; background: rgba(255, 62, 62, 0.95); padding: 20px 40px; border-radius: 8px; display: none; color: white; font-weight: bold; font-size: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.7); z-index: 100; animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background: rgba(255, 62, 62, 0.95); } 50% { background: rgba(255, 0, 0, 1); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="color: var(--safe);">DAS MONITOR</h2>
        <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 20px;">Project: das-2025 <br>Trạng thái: <span id="conn-status" style="color:yellow">Connecting...</span></div>
        
        <h3>Trạng thái Tuyến cáp</h3>
        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 4px;">
            <div><span id="sys-status" class="status-indicator"></span> <span id="sys-text">An toàn</span></div>
            <div style="margin-top: 15px;">Năng lượng rung động: <b id="current-energy" style="font-size: 1.2rem">0.0</b></div>
        </div>
        
        <div style="margin-top: auto; font-size: 0.8rem; color: #aaa;">
            Luận văn Thạc sĩ 2025<br>
            Demo Hệ thống IoT & AI
        </div>
    </div>

    <div class="main-content">
        <div id="alert-overlay">⚠️ CẢNH BÁO XÂM NHẬP</div>
        <div id="map-container">
            <canvas id="fieldMap"></canvas>
        </div>
        <div class="dashboard">
            <div style="flex:2; position: relative;">
                <span style="position: absolute; top: 5px; left: 10px; font-size: 12px; color: #aaa;">BIỂU ĐỒ TÍN HIỆU THỜI GIAN THỰC</span>
                <canvas id="signalChart"></canvas>
            </div>
        </div>
    </div>

<script>
    // --- 1. CẤU HÌNH FIREBASE CỦA BẠN ---
    const firebaseConfig = {
        apiKey: "AIzaSyBAKgjfwqPcYhUxLo__ISxd7xax3GYZDkk",
        authDomain: "das-2025.firebaseapp.com",
        // Lưu ý: Đã tự động thêm databaseURL mặc định. Nếu không chạy, hãy kiểm tra lại URL trong Firebase Console
        databaseURL: "https://das-2025-default-rtdb.firebaseio.com",
        projectId: "das-2025",
        storageBucket: "das-2025.firebasestorage.app",
        messagingSenderId: "911247179996",
        appId: "1:911247179996:web:ecce7b5227266573807419"
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Kiểm tra kết nối
    const connectedRef = db.ref(".info/connected");
    connectedRef.on("value", (snap) => {
        const el = document.getElementById('conn-status');
        if (snap.val() === true) {
            el.innerText = "Online";
            el.style.color = "lime";
        } else {
            el.innerText = "Offline";
            el.style.color = "red";
        }
    });

    // --- 2. LOGIC MONITOR ---
    let vehicles = []; 
    const mapCanvas = document.getElementById('fieldMap');
    const chartCanvas = document.getElementById('signalChart');
    const ctxMap = mapCanvas.getContext('2d');
    const ctxChart = chartCanvas.getContext('2d');
    let time = 0;
    let signalData = new Array(200).fill(0);
    const CABLE_Y_POS = 0.5; 
    const DETECTION_RADIUS = 150;
    const ALERT_THRESHOLD = 0.6;

    function resize() {
        mapCanvas.width = mapCanvas.offsetWidth;
        mapCanvas.height = mapCanvas.offsetHeight;
        chartCanvas.width = chartCanvas.offsetWidth;
        chartCanvas.height = chartCanvas.offsetHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // LẮNG NGHE DỮ LIỆU TỪ FIREBASE (REALTIME)
    db.ref('simulation/scene').on('value', (snapshot) => {
        const data = snapshot.val();
        vehicles = [];
        if (data) {
            Object.values(data).forEach(v => {
                vehicles.push({
                    x: v.xP * mapCanvas.width, 
                    y: v.yP * mapCanvas.height,
                    type: v.type,
                    icon: v.icon,
                    amp: v.amp
                });
            });
        }
    });

    // PHYSICS ENGINE
    function calculateSignal() {
        let totalSignal = 0;
        let noise = (Math.random() - 0.5) * 0.1; 
        const cableY = mapCanvas.height * CABLE_Y_POS;
        let maxThreat = 0;
        let threatLoc = 0;

        vehicles.forEach(v => {
            const dist = Math.abs(v.y - cableY);
            if (dist < DETECTION_RADIUS) {
                const attenuation = 1 - (dist / DETECTION_RADIUS);
                let vibration = 0;
                if(v.type === 'drill') vibration = v.amp * Math.sin(time * 20) * attenuation;
                else if (v.type === 'excavator') vibration = v.amp * (Math.sin(time * 5) + Math.random()) * attenuation;
                else vibration = v.amp * Math.sin(time * 2) * attenuation;
                
                totalSignal += vibration;
                if (attenuation * v.amp > maxThreat) {
                    maxThreat = attenuation * v.amp;
                    threatLoc = v.x;
                }
            }
        });
        return { val: totalSignal + noise, maxEnergy: Math.abs(totalSignal), threatLoc };
    }

    function animate() {
        time += 0.1;
        ctxMap.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
        ctxChart.clearRect(0, 0, chartCanvas.width, chartCanvas.height);

        // Vẽ Cáp
        const cableY = mapCanvas.height * CABLE_Y_POS;
        ctxMap.fillStyle = "rgba(0, 242, 195, 0.05)";
        ctxMap.fillRect(0, cableY - DETECTION_RADIUS, mapCanvas.width, DETECTION_RADIUS * 2);
        ctxMap.beginPath();
        ctxMap.moveTo(0, cableY); ctxMap.lineTo(mapCanvas.width, cableY);
        ctxMap.strokeStyle = "#00f2c3"; ctxMap.lineWidth = 3; ctxMap.setLineDash([10, 5]); ctxMap.stroke(); ctxMap.setLineDash([]);
        ctxMap.fillStyle = "#00f2c3"; ctxMap.font = "14px Arial"; ctxMap.fillText("Tuyến Cáp Ngầm 220kV (Km 0.0 - Km 1.0)", 10, cableY - 10);

        // Vẽ Phương tiện (Sync từ hiện trường)
        vehicles.forEach(v => {
            ctxMap.font = "30px Arial"; ctxMap.fillText(v.icon, v.x - 15, v.y + 10);
            const dist = Math.abs(v.y - cableY);
            if (dist < DETECTION_RADIUS) {
                ctxMap.beginPath(); ctxMap.arc(v.x, v.y, (Math.sin(time*2)+1)*20, 0, Math.PI*2);
                ctxMap.strokeStyle = `rgba(255, 62, 62, ${1-dist/DETECTION_RADIUS})`; ctxMap.stroke();
            }
        });

        // Xử lý tín hiệu
        const data = calculateSignal();
        signalData.push(data.val); signalData.shift();
        document.getElementById('current-energy').innerText = data.maxEnergy.toFixed(2);

        // Cảnh báo
        const alertBox = document.getElementById('alert-overlay');
        if (data.maxEnergy > ALERT_THRESHOLD) {
            document.getElementById('sys-status').className = "status-indicator status-danger";
            document.getElementById('sys-text').innerText = "PHÁT HIỆN NGUY HIỂM!";
            document.getElementById('sys-text').style.color = "var(--danger)";
            
            const km = (data.threatLoc / mapCanvas.width).toFixed(3);
            alertBox.style.display = "block";
            alertBox.innerText = `⚠️ XÂM NHẬP TẠI KM ${km}`;
            
            // Marker định vị
            ctxMap.beginPath(); ctxMap.arc(data.threatLoc, cableY, 15, 0, Math.PI*2);
            ctxMap.fillStyle = "red"; ctxMap.fill();
            ctxMap.fillStyle = "white"; ctxMap.fillText(`Target: Km ${km}`, data.threatLoc + 15, cableY - 20);
        } else {
            document.getElementById('sys-status').className = "status-indicator";
            document.getElementById('sys-text').innerText = "An toàn";
            document.getElementById('sys-text').style.color = "var(--text-color)";
            alertBox.style.display = "none";
        }

        // Vẽ biểu đồ
        ctxChart.beginPath(); ctxChart.strokeStyle = "#e14eca"; ctxChart.lineWidth = 2;
        const sliceWidth = chartCanvas.width / signalData.length;
        let x = 0;
        const centerY = chartCanvas.height / 2;
        for(let i=0; i<signalData.length; i++) {
            const y = centerY - (signalData[i] * 40);
            if(i===0) ctxChart.moveTo(x, y); else ctxChart.lineTo(x, y);
            x += sliceWidth;
        }
        ctxChart.stroke();

        // Vẽ ngưỡng
        const thY = centerY - (ALERT_THRESHOLD * 40);
        ctxChart.beginPath(); ctxChart.strokeStyle = "red"; ctxChart.setLineDash([5,5]);
        ctxChart.moveTo(0, thY); ctxChart.lineTo(chartCanvas.width, thY); ctxChart.stroke(); ctxChart.setLineDash([]);

        requestAnimationFrame(animate);
    }
    animate();
</script>
</body>
</html>
